import{jsx as o,jsxs as a}from"react/jsx-runtime";import{useState as f,useRef as k,useEffect as $}from"react";import{useTranslation as U}from"react-i18next";import v from"../../components/ui/Button";function j(){const{t:s}=U(),A=k(null),h=k(null),M=k(null),[c,E]=f(null),[u,g]=f([]),[d,I]=f("arrow"),[F,N]=f(null),[C,p]=f(!1),[m,S]=f({x:0,y:0}),[b,W]=f(1),[n,x]=f({color:"#ff0000",strokeWidth:3,fontSize:16}),L=l=>{const t=l.target.files?.[0];if(!t)return;const e=new Image;e.onload=()=>{E(e),g([]),N(null);const r=M.current;if(r){const i=r.clientWidth-32,y=Math.min(i/e.width,450/e.height,1);W(y)}},e.src=URL.createObjectURL(t)},R=()=>{if(!h.current||!c)return;const l=h.current,t=l.getContext("2d");t&&(l.width=c.width,l.height=c.height,t.drawImage(c,0,0),u.forEach(e=>{switch(t.strokeStyle=e.color,t.fillStyle=e.color,t.lineWidth=e.strokeWidth,e.type){case"arrow":if(e.endX!==void 0&&e.endY!==void 0){const r=Math.atan2(e.endY-e.y,e.endX-e.x),i=15;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.endX,e.endY),t.stroke(),t.beginPath(),t.moveTo(e.endX,e.endY),t.lineTo(e.endX-i*Math.cos(r-Math.PI/6),e.endY-i*Math.sin(r-Math.PI/6)),t.lineTo(e.endX-i*Math.cos(r+Math.PI/6),e.endY-i*Math.sin(r+Math.PI/6)),t.closePath(),t.fill()}break;case"rectangle":e.width&&e.height&&t.strokeRect(e.x,e.y,e.width,e.height);break;case"circle":if(e.width&&e.height){const r=Math.abs(e.width)/2,i=Math.abs(e.height)/2,T=e.x+e.width/2,y=e.y+e.height/2;t.beginPath(),t.ellipse(T,y,r,i,0,0,2*Math.PI),t.stroke()}break;case"line":e.endX!==void 0&&e.endY!==void 0&&(t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.endX,e.endY),t.stroke());break;case"text":e.text&&(t.font=`${n.fontSize}px sans-serif`,t.fillText(e.text,e.x,e.y));break}}))};$(()=>{R()},[c,u]);const w=l=>{const t=h.current;if(!t)return{x:0,y:0};const e=t.getBoundingClientRect();return{x:(l.clientX-e.left)/b,y:(l.clientY-e.top)/b}},X=l=>{const t=w(l);if(p(!0),S(t),d==="text"){const e=prompt(s("tools.imageAnnotator.enterText"));if(e){const r={id:`${Date.now()}`,type:"text",x:t.x,y:t.y,text:e,color:n.color,strokeWidth:n.strokeWidth};g(i=>[...i,r])}p(!1)}},Y=l=>{if(!C||d==="text")return;const t=w(l),e={id:"temp",type:d,x:m.x,y:m.y,color:n.color,strokeWidth:n.strokeWidth};d==="arrow"||d==="line"?(e.endX=t.x,e.endY=t.y):(e.width=t.x-m.x,e.height=t.y-m.y),g(r=>[...r.filter(i=>i.id!=="temp"),e])},P=l=>{if(!C||d==="text")return;const t=w(l),e={id:`${Date.now()}`,type:d,x:m.x,y:m.y,color:n.color,strokeWidth:n.strokeWidth};d==="arrow"||d==="line"?(e.endX=t.x,e.endY=t.y):(e.width=t.x-m.x,e.height=t.y-m.y),g(r=>[...r.filter(i=>i.id!=="temp"),e]),p(!1)},H=()=>{if(!h.current)return;const l=document.createElement("a");l.href=h.current.toDataURL("image/png"),l.download=`annotated-${Date.now()}.png`,l.click()},D=()=>{g(l=>l.slice(0,-1))},z=()=>{g([]),N(null)},B=[{id:"arrow",icon:"\u2197",label:s("tools.imageAnnotator.arrow")},{id:"rectangle",icon:"\u25A1",label:s("tools.imageAnnotator.rectangle")},{id:"circle",icon:"\u25CB",label:s("tools.imageAnnotator.circle")},{id:"line",icon:"/",label:s("tools.imageAnnotator.line")},{id:"text",icon:"T",label:s("tools.imageAnnotator.text")}];return a("div",{className:"flex flex-col gap-4",children:[a("div",{className:"flex gap-2 flex-wrap items-center",children:[o(v,{onClick:()=>A.current?.click(),children:s(c?"tools.imageAnnotator.changeImage":"tools.imageAnnotator.selectImage")}),o("input",{ref:A,type:"file",accept:"image/*",onChange:L,className:"hidden"}),o(v,{variant:"secondary",onClick:D,disabled:u.length===0,children:s("tools.imageAnnotator.undo")}),o(v,{variant:"secondary",onClick:z,disabled:u.length===0,children:s("common.clear")}),o(v,{variant:"secondary",onClick:H,disabled:!c,children:s("common.download")}),o("div",{className:"flex-1"}),a("span",{className:"text-sm text-slate-500",children:[u.filter(l=>l.id!=="temp").length," ",s("tools.imageAnnotator.annotations")]})]}),a("div",{className:"flex gap-4",children:[a("div",{className:"flex-1 flex flex-col gap-4",ref:M,children:[o("div",{className:"flex gap-2 flex-wrap",children:B.map(l=>a("button",{onClick:()=>I(l.id),className:`px-3 py-2 rounded-lg border ${d===l.id?"bg-blue-500 text-white border-blue-500":"bg-white border-slate-200 hover:bg-slate-50"}`,title:l.label,children:[o("span",{className:"text-lg mr-1",children:l.icon}),o("span",{className:"text-sm",children:l.label})]},l.id))}),o("div",{className:"flex justify-center p-4 bg-slate-100 rounded-lg min-h-[400px] overflow-auto",children:c?o("canvas",{ref:h,onMouseDown:X,onMouseMove:Y,onMouseUp:P,onMouseLeave:()=>p(!1),className:"cursor-crosshair shadow-lg",style:{width:c.width*b,height:c.height*b}}):o("div",{className:"flex items-center justify-center text-slate-400 h-full",children:s("tools.imageAnnotator.placeholder")})})]}),a("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4",children:[o("h3",{className:"font-semibold text-slate-700",children:s("tools.imageAnnotator.settings")}),a("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:s("tools.imageAnnotator.color")}),a("div",{className:"flex gap-2",children:[o("input",{type:"color",value:n.color,onChange:l=>x({...n,color:l.target.value}),className:"w-10 h-10 rounded cursor-pointer"}),o("input",{type:"text",value:n.color,onChange:l=>x({...n,color:l.target.value}),className:"flex-1 p-2 border border-slate-200 rounded text-sm font-mono"})]})]}),o("div",{className:"flex gap-2 flex-wrap",children:["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#000000","#ffffff"].map(l=>o("button",{onClick:()=>x({...n,color:l}),className:`w-8 h-8 rounded border-2 ${n.color===l?"border-blue-500":"border-slate-200"}`,style:{backgroundColor:l}},l))}),a("div",{children:[a("label",{className:"block text-xs text-slate-500 mb-1",children:[s("tools.imageAnnotator.strokeWidth"),": ",n.strokeWidth,"px"]}),o("input",{type:"range",min:"1",max:"10",value:n.strokeWidth,onChange:l=>x({...n,strokeWidth:Number(l.target.value)}),className:"w-full"})]}),a("div",{children:[a("label",{className:"block text-xs text-slate-500 mb-1",children:[s("tools.imageAnnotator.fontSize"),": ",n.fontSize,"px"]}),o("input",{type:"range",min:"12",max:"48",value:n.fontSize,onChange:l=>x({...n,fontSize:Number(l.target.value)}),className:"w-full"})]}),a("div",{className:"pt-4 border-t border-slate-200",children:[o("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:s("tools.imageAnnotator.tips")}),a("ul",{className:"text-xs text-slate-500 space-y-1",children:[a("li",{children:["\u2022 ",s("tools.imageAnnotator.tip1")]}),a("li",{children:["\u2022 ",s("tools.imageAnnotator.tip2")]}),a("li",{children:["\u2022 ",s("tools.imageAnnotator.tip3")]})]})]})]})]})]})}export{j as default};
