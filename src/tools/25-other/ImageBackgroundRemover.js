import{jsx as t,jsxs as s}from"react/jsx-runtime";import{useState as R,useRef as E,useEffect as K}from"react";import{useTranslation as Q}from"react-i18next";import C from"../../components/ui/Button";function V(){const{t:a}=Q(),j=E(null),b=E(null),I=E(null),[u,A]=R(null),[m,H]=R(null),[h,y]=R(null),[B,L]=R(!1),[c,p]=R({tolerance:30,feather:2,targetColor:"#ffffff",useAutoDetect:!0}),U=e=>{const o=e.target.files?.[0];if(!o)return;const l=new Image;l.onload=()=>{A(l),y(null);const n=b.current;if(n){n.width=l.width,n.height=l.height;const r=n.getContext("2d");r&&(r.drawImage(l,0,0),H(r.getImageData(0,0,l.width,l.height)))}},l.src=URL.createObjectURL(o)},F=e=>{const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:{r:255,g:255,b:255}},O=(e,o,l,n,r,g)=>Math.sqrt(Math.pow(e-n,2)+Math.pow(o-r,2)+Math.pow(l-g,2)),P=e=>{const o=e.data,l=e.width,n=e.height,r=[];[[0,0],[l-1,0],[0,n-1],[l-1,n-1],[Math.floor(l/2),0],[Math.floor(l/2),n-1],[0,Math.floor(n/2)],[l-1,Math.floor(n/2)]].forEach(([d,i])=>{const v=(i*l+d)*4;r.push({r:o[v],g:o[v+1],b:o[v+2]})});const k=Math.round(r.reduce((d,i)=>d+i.r,0)/r.length),w=Math.round(r.reduce((d,i)=>d+i.g,0)/r.length),D=Math.round(r.reduce((d,i)=>d+i.b,0)/r.length);return{r:k,g:w,b:D}},S=()=>{!m||!b.current||!I.current||(L(!0),setTimeout(()=>{const e=b.current,o=I.current,l=e.getContext("2d"),n=o.getContext("2d"),r=new ImageData(new Uint8ClampedArray(m.data),m.width,m.height),g=r.data,{tolerance:k,feather:w,targetColor:D,useAutoDetect:d}=c;let i;d?i=P(m):i=F(D);const v=k/100*441.67;for(let f=0;f<g.length;f+=4){const G=g[f],W=g[f+1],z=g[f+2],M=O(G,W,z,i.r,i.g,i.b);if(M<v)if(w>0&&M>v*(1-w/10)){const J=Math.round(255*(M/v));g[f+3]=J}else g[f+3]=0}e.width=m.width,e.height=m.height,l.putImageData(r,0,0),o.width=m.width,o.height=m.height;const N=document.createElement("canvas");N.width=20,N.height=20;const x=N.getContext("2d");x.fillStyle="#ffffff",x.fillRect(0,0,20,20),x.fillStyle="#e5e5e5",x.fillRect(0,0,10,10),x.fillRect(10,10,10,10);const T=n.createPattern(N,"repeat");T&&(n.fillStyle=T,n.fillRect(0,0,o.width,o.height)),n.drawImage(e,0,0),y(e.toDataURL("image/png")),L(!1)},100))},$=()=>{if(!h)return;const e=document.createElement("a");e.href=h,e.download=`bg-removed-${Date.now()}.png`,e.click()},q=()=>{if(!u||!b.current)return;const o=b.current.getContext("2d");o&&m&&o.putImageData(m,0,0),y(null)};return K(()=>{u&&m&&S()},[c]),s("div",{className:"flex flex-col gap-4",children:[s("div",{className:"flex gap-2 flex-wrap items-center",children:[t(C,{onClick:()=>j.current?.click(),children:a(u?"tools.bgRemover.changeImage":"tools.bgRemover.selectImage")}),t("input",{ref:j,type:"file",accept:"image/*",onChange:U,className:"hidden"}),t(C,{variant:"secondary",onClick:S,disabled:!u||B,children:a(B?"tools.bgRemover.processing":"tools.bgRemover.remove")}),t(C,{variant:"secondary",onClick:$,disabled:!h,children:a("tools.bgRemover.download")}),t(C,{variant:"secondary",onClick:q,disabled:!u,children:a("tools.bgRemover.reset")})]}),s("div",{className:"flex gap-4",children:[s("div",{className:"flex-1 flex flex-col gap-4",children:[s("div",{className:"grid grid-cols-2 gap-4",children:[s("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-2",children:a("tools.bgRemover.original")}),t("div",{className:"flex justify-center p-4 bg-slate-100 rounded-lg min-h-[250px] overflow-auto",children:u?t("img",{src:u.src,alt:"Original",className:"max-w-full max-h-[250px] shadow-lg rounded object-contain"}):t("div",{className:"flex items-center justify-center text-slate-400 h-full",children:a("tools.bgRemover.placeholder")})})]}),s("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-2",children:a("tools.bgRemover.result")}),t("div",{className:"flex justify-center p-4 bg-slate-100 rounded-lg min-h-[250px] overflow-auto",children:h?t("canvas",{ref:I,className:"max-w-full max-h-[250px] shadow-lg rounded object-contain",style:{maxWidth:"100%",maxHeight:"250px",objectFit:"contain"}}):t("div",{className:"flex items-center justify-center text-slate-400 h-full",children:a(u?"tools.bgRemover.clickRemove":"tools.bgRemover.selectFirst")})})]})]}),t("canvas",{ref:b,className:"hidden"}),h&&s("div",{className:"p-4 bg-green-50 rounded-lg border border-green-200",children:[s("div",{className:"flex items-center gap-2 text-green-700",children:[t("span",{className:"text-lg",children:"\u2713"}),t("span",{className:"font-medium",children:a("tools.bgRemover.success")})]}),t("p",{className:"text-sm text-green-600 mt-1",children:a("tools.bgRemover.successHint")})]})]}),s("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4",children:[t("h3",{className:"font-semibold text-slate-700",children:a("tools.bgRemover.settings")}),t("div",{children:s("label",{className:"flex items-center gap-2 text-sm text-slate-600",children:[t("input",{type:"checkbox",checked:c.useAutoDetect,onChange:e=>p({...c,useAutoDetect:e.target.checked}),className:"rounded"}),a("tools.bgRemover.autoDetect")]})}),!c.useAutoDetect&&s("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:a("tools.bgRemover.targetColor")}),s("div",{className:"flex gap-2",children:[t("input",{type:"color",value:c.targetColor,onChange:e=>p({...c,targetColor:e.target.value}),className:"w-10 h-10 rounded cursor-pointer"}),t("input",{type:"text",value:c.targetColor,onChange:e=>p({...c,targetColor:e.target.value}),className:"flex-1 p-2 border border-slate-200 rounded text-sm font-mono"})]})]}),s("div",{children:[s("label",{className:"block text-xs text-slate-500 mb-1",children:[a("tools.bgRemover.tolerance"),": ",c.tolerance,"%"]}),t("input",{type:"range",min:"1",max:"100",value:c.tolerance,onChange:e=>p({...c,tolerance:Number(e.target.value)}),className:"w-full"}),s("div",{className:"flex justify-between text-xs text-slate-400 mt-1",children:[t("span",{children:a("tools.bgRemover.precise")}),t("span",{children:a("tools.bgRemover.loose")})]})]}),s("div",{children:[s("label",{className:"block text-xs text-slate-500 mb-1",children:[a("tools.bgRemover.feather"),": ",c.feather]}),t("input",{type:"range",min:"0",max:"10",value:c.feather,onChange:e=>p({...c,feather:Number(e.target.value)}),className:"w-full"}),s("div",{className:"flex justify-between text-xs text-slate-400 mt-1",children:[t("span",{children:a("tools.bgRemover.sharp")}),t("span",{children:a("tools.bgRemover.soft")})]})]}),s("div",{className:"pt-4 border-t border-slate-200",children:[t("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:a("tools.bgRemover.tips")}),s("ul",{className:"text-xs text-slate-500 space-y-1",children:[s("li",{children:["\u2022 ",a("tools.bgRemover.tip1")]}),s("li",{children:["\u2022 ",a("tools.bgRemover.tip2")]}),s("li",{children:["\u2022 ",a("tools.bgRemover.tip3")]})]})]})]})]})]})}export{V as default};
