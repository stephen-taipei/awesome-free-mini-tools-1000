import{jsx as a,jsxs as r}from"react/jsx-runtime";import{useState as f,useRef as v,useEffect as Y}from"react";import{useTranslation as A}from"react-i18next";import w from"../../components/ui/Button";function D(){const{t:i}=A(),y=v(null),h=v(null),M=v(null),[n,I]=f(null),[p,H]=f(1),[E,N]=f(!1),[x,R]=f({x:0,y:0}),[l,c]=f({blurType:"full",blurAmount:10,regionX:0,regionY:0,regionWidth:100,regionHeight:100}),k=e=>{const t=e.target.files?.[0];if(!t)return;const o=new Image;o.onload=()=>{I(o);const d=M.current;if(d){const s=d.clientWidth-32,u=Math.min(s/o.width,450/o.height,1);H(u)}c(s=>({...s,regionX:Math.floor(o.width/4),regionY:Math.floor(o.height/4),regionWidth:Math.floor(o.width/2),regionHeight:Math.floor(o.height/2)}))},o.src=URL.createObjectURL(t)},B=()=>{if(!h.current||!n)return;const e=h.current,t=e.getContext("2d");if(t)if(e.width=n.width,e.height=n.height,t.drawImage(n,0,0),l.blurType==="full")t.filter=`blur(${l.blurAmount}px)`,t.drawImage(n,0,0),t.filter="none";else{const{regionX:o,regionY:d,regionWidth:s,regionHeight:m}=l,u=document.createElement("canvas");u.width=s,u.height=m;const g=u.getContext("2d");if(!g)return;g.drawImage(n,o,d,s,m,0,0,s,m),g.filter=`blur(${l.blurAmount}px)`,g.drawImage(u,0,0),g.filter="none",t.drawImage(u,o,d),t.strokeStyle="#3b82f6",t.lineWidth=2,t.setLineDash([5,5]),t.strokeRect(o,d,s,m),t.setLineDash([])}};Y(()=>{n&&B()},[n,l]);const C=e=>{const t=h.current;if(!t)return{x:0,y:0};const o=t.getBoundingClientRect();return{x:Math.round((e.clientX-o.left)/p),y:Math.round((e.clientY-o.top)/p)}},L=e=>{if(l.blurType!=="region")return;const t=C(e);N(!0),R(t)},S=e=>{if(!E||l.blurType!=="region")return;const t=C(e);c(o=>({...o,regionX:Math.min(x.x,t.x),regionY:Math.min(x.y,t.y),regionWidth:Math.abs(t.x-x.x),regionHeight:Math.abs(t.y-x.y)}))},T=()=>{N(!1)},W=()=>{if(!h.current||!n)return;const e=h.current,t=e.getContext("2d");if(!t)return;if(e.width=n.width,e.height=n.height,t.drawImage(n,0,0),l.blurType==="full")t.filter=`blur(${l.blurAmount}px)`,t.drawImage(n,0,0),t.filter="none";else{const{regionX:d,regionY:s,regionWidth:m,regionHeight:u}=l,g=document.createElement("canvas");g.width=m,g.height=u;const b=g.getContext("2d");if(!b)return;b.drawImage(n,d,s,m,u,0,0,m,u),b.filter=`blur(${l.blurAmount}px)`,b.drawImage(g,0,0),b.filter="none",t.drawImage(g,d,s)}const o=document.createElement("a");o.href=e.toDataURL("image/png"),o.download=`blurred-${Date.now()}.png`,o.click(),B()},X=()=>{n&&c(e=>({...e,regionX:Math.floor(n.width/4),regionY:Math.floor(n.height/4),regionWidth:Math.floor(n.width/2),regionHeight:Math.floor(n.height/2)}))};return r("div",{className:"flex flex-col gap-4",children:[r("div",{className:"flex gap-2 flex-wrap items-center",children:[a(w,{onClick:()=>y.current?.click(),children:i(n?"tools.imageBlur.changeImage":"tools.imageBlur.selectImage")}),a("input",{ref:y,type:"file",accept:"image/*",onChange:k,className:"hidden"}),a(w,{variant:"secondary",onClick:W,disabled:!n,children:i("common.download")}),l.blurType==="region"&&a(w,{variant:"secondary",onClick:X,disabled:!n,children:i("tools.imageBlur.resetRegion")})]}),r("div",{className:"flex gap-4",children:[r("div",{className:"flex-1 flex flex-col gap-4",ref:M,children:[a("div",{className:"flex justify-center p-4 bg-slate-100 rounded-lg min-h-[400px] overflow-auto",children:n?a("canvas",{ref:h,onMouseDown:L,onMouseMove:S,onMouseUp:T,onMouseLeave:T,className:`shadow-lg ${l.blurType==="region"?"cursor-crosshair":"cursor-default"}`,style:{width:n.width*p,height:n.height*p}}):a("div",{className:"flex items-center justify-center text-slate-400 h-full",children:i("tools.imageBlur.placeholder")})}),l.blurType==="region"&&n&&a("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200 text-sm text-blue-600",children:i("tools.imageBlur.regionHint")})]}),r("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4",children:[a("h3",{className:"font-semibold text-slate-700",children:i("tools.imageBlur.settings")}),r("div",{children:[a("label",{className:"block text-xs text-slate-500 mb-1",children:i("tools.imageBlur.blurType")}),r("select",{value:l.blurType,onChange:e=>c({...l,blurType:e.target.value}),className:"w-full p-2 border border-slate-200 rounded text-sm",children:[a("option",{value:"full",children:i("tools.imageBlur.fullImage")}),a("option",{value:"region",children:i("tools.imageBlur.regionOnly")})]})]}),r("div",{children:[r("label",{className:"block text-xs text-slate-500 mb-1",children:[i("tools.imageBlur.blurAmount"),": ",l.blurAmount,"px"]}),a("input",{type:"range",min:"1",max:"50",value:l.blurAmount,onChange:e=>c({...l,blurAmount:Number(e.target.value)}),className:"w-full"}),r("div",{className:"flex justify-between text-xs text-slate-400 mt-1",children:[a("span",{children:i("tools.imageBlur.light")}),a("span",{children:i("tools.imageBlur.heavy")})]})]}),l.blurType==="region"&&r("div",{className:"space-y-3 p-3 bg-slate-50 rounded-lg",children:[a("h4",{className:"text-xs font-medium text-slate-500",children:i("tools.imageBlur.regionSettings")}),r("div",{className:"grid grid-cols-2 gap-2",children:[r("div",{children:[a("label",{className:"block text-xs text-slate-400",children:"X"}),a("input",{type:"number",value:l.regionX,onChange:e=>c({...l,regionX:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]}),r("div",{children:[a("label",{className:"block text-xs text-slate-400",children:"Y"}),a("input",{type:"number",value:l.regionY,onChange:e=>c({...l,regionY:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]}),r("div",{children:[a("label",{className:"block text-xs text-slate-400",children:i("tools.imageBlur.width")}),a("input",{type:"number",value:l.regionWidth,onChange:e=>c({...l,regionWidth:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]}),r("div",{children:[a("label",{className:"block text-xs text-slate-400",children:i("tools.imageBlur.height")}),a("input",{type:"number",value:l.regionHeight,onChange:e=>c({...l,regionHeight:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]})]})]}),r("div",{className:"pt-4 border-t border-slate-200",children:[a("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:i("tools.imageBlur.tips")}),r("ul",{className:"text-xs text-slate-500 space-y-1",children:[r("li",{children:["\u2022 ",i("tools.imageBlur.tip1")]}),r("li",{children:["\u2022 ",i("tools.imageBlur.tip2")]}),r("li",{children:["\u2022 ",i("tools.imageBlur.tip3")]})]})]})]})]})]})}export{D as default};
