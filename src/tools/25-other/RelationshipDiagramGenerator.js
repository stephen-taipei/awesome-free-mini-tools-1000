import{jsx as o,jsxs as s}from"react/jsx-runtime";import{useState as m,useRef as P}from"react";import{useTranslation as Y}from"react-i18next";import L from"../../components/ui/Button";function $(){const{t:n}=Y(),g=P(null),[r,f]=m([{id:"1",x:200,y:300,label:"Person A",color:"#3b82f6"},{id:"2",x:600,y:300,label:"Person B",color:"#ef4444"}]),[p,y]=m([{id:"l1",sourceId:"1",targetId:"2",label:"Friends"}]),[i,h]=m(null),[d,u]=m("select"),[x,v]=m(null),[S,w]=m(!1),[k,M]=m({x:0,y:0}),C=e=>{if(d==="addNode"){const t=g.current?.getBoundingClientRect();if(!t)return;const a=e.clientX-t.left,l=e.clientY-t.top,c={id:Date.now().toString(),x:a,y:l,label:"New Person",color:"#3b82f6"};f([...r,c]),u("select")}else h(null),v(null)},R=(e,t)=>{if(e.stopPropagation(),d==="addLink"){if(x===null)v(t);else if(x!==t){const l={id:Date.now().toString(),sourceId:x,targetId:t,label:"Relation"};y([...p,l]),v(null),u("select")}return}h(t),w(!0);const a=r.find(l=>l.id===t);a&&M({x:e.clientX-a.x,y:e.clientY-a.y})},E=e=>{if(S&&i&&d==="select"){const t=e.clientX-k.x,a=e.clientY-k.y;f(r.map(l=>l.id===i?{...l,x:t,y:a}:l))}},D=()=>{w(!1)},I=e=>{i&&f(r.map(t=>t.id===i?{...t,...e}:t))},B=()=>{i&&(f(r.filter(e=>e.id!==i)),y(p.filter(e=>e.sourceId!==i&&e.targetId!==i)),h(null))},X=()=>{if(!g.current)return;const e=new XMLSerializer().serializeToString(g.current),t=document.createElement("canvas"),a=t.getContext("2d"),l=new Image;t.width=800,t.height=600,l.onload=()=>{if(a){a.fillStyle="white",a.fillRect(0,0,t.width,t.height),a.drawImage(l,0,0);const c=document.createElement("a");c.download="relationship-diagram.png",c.href=t.toDataURL("image/png"),c.click()}},l.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},b=r.find(e=>e.id===i);return s("div",{className:"flex flex-col gap-4 h-[600px]",children:[s("div",{className:"flex gap-2 flex-wrap items-center",children:[s("div",{className:"flex rounded-lg bg-slate-100 p-1",children:[o("button",{className:`px-3 py-1 rounded text-sm font-medium transition-colors ${d==="select"?"bg-white text-primary-600 shadow-sm":"text-slate-600 hover:text-slate-900"}`,onClick:()=>u("select"),children:n("tools.relationshipDiagram.select")}),o("button",{className:`px-3 py-1 rounded text-sm font-medium transition-colors ${d==="addNode"?"bg-white text-primary-600 shadow-sm":"text-slate-600 hover:text-slate-900"}`,onClick:()=>u("addNode"),children:n("tools.relationshipDiagram.addNode")}),o("button",{className:`px-3 py-1 rounded text-sm font-medium transition-colors ${d==="addLink"?"bg-white text-primary-600 shadow-sm":"text-slate-600 hover:text-slate-900"}`,onClick:()=>u("addLink"),children:n("tools.relationshipDiagram.addLink")})]}),d==="addLink"&&x&&o("span",{className:"text-sm text-primary-600 animate-pulse",children:n("tools.relationshipDiagram.selectTarget")}),o("div",{className:"flex-1"}),o(L,{variant:"secondary",onClick:X,children:n("common.download")})]}),s("div",{className:"flex gap-4 flex-1 min-h-0",children:[s("div",{className:"flex-1 border border-slate-200 rounded-lg bg-white overflow-hidden shadow-inner relative cursor-crosshair",onMouseMove:E,onMouseUp:D,onMouseLeave:D,onClick:C,children:[s("svg",{ref:g,viewBox:"0 0 800 600",className:"w-full h-full select-none",children:[o("defs",{children:o("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"7",refX:"28",refY:"3.5",orient:"auto",children:o("polygon",{points:"0 0, 10 3.5, 0 7",fill:"#94a3b8"})})}),p.map(e=>{const t=r.find(N=>N.id===e.sourceId),a=r.find(N=>N.id===e.targetId);if(!t||!a)return null;const l=(t.x+a.x)/2,c=(t.y+a.y)/2;return s("g",{children:[o("line",{x1:t.x,y1:t.y,x2:a.x,y2:a.y,stroke:"#94a3b8",strokeWidth:"2",markerEnd:"url(#arrowhead)"}),o("text",{x:l,y:c,dy:"-5",textAnchor:"middle",fill:"#64748b",fontSize:"12",className:"bg-white",children:e.label})]},e.id)}),r.map(e=>s("g",{transform:`translate(${e.x}, ${e.y})`,onMouseDown:t=>R(t,e.id),className:"cursor-move",style:{outline:i===e.id?"2px solid #3b82f6":"none"},children:[o("circle",{r:"20",fill:e.color}),o("text",{dy:"35",textAnchor:"middle",className:"text-sm font-medium select-none pointer-events-none",fill:"#1e293b",children:e.label})]},e.id))]}),o("div",{className:"absolute bottom-2 right-2 text-xs text-slate-400 pointer-events-none",children:"800 x 600"})]}),s("div",{className:"w-64 border-l border-slate-200 pl-4 flex flex-col gap-4",children:[o("h3",{className:"font-semibold text-slate-700",children:n("tools.relationshipDiagram.properties")}),b?s("div",{className:"space-y-4",children:[s("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:n("tools.relationshipDiagram.label")}),o("input",{type:"text",value:b.label,onChange:e=>I({label:e.target.value}),className:"input w-full"})]}),s("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:n("tools.relationshipDiagram.color")}),o("input",{type:"color",value:b.color,onChange:e=>I({color:e.target.value}),className:"w-full h-8 rounded cursor-pointer"})]}),o(L,{variant:"secondary",className:"w-full text-red-500 hover:text-red-600 hover:bg-red-50",onClick:B,children:n("tools.relationshipDiagram.delete")})]}):o("div",{className:"text-sm text-slate-400",children:n("tools.relationshipDiagram.selectHint")})]})]})]})}export{$ as default};
