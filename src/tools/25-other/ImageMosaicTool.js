import{jsx as o,jsxs as s}from"react/jsx-runtime";import{useState as b,useRef as w,useEffect as P}from"react";import{useTranslation as F}from"react-i18next";import T from"../../components/ui/Button";function q(){const{t:l}=F(),H=w(null),d=w(null),S=w(null),[i,E]=b(null),[v,I]=b(1),[L,C]=b(!1),[M,W]=b({x:0,y:0}),[a,c]=b({mosaicType:"region",pixelSize:15,regionX:0,regionY:0,regionWidth:100,regionHeight:100}),D=e=>{const n=e.target.files?.[0];if(!n)return;const t=new Image;t.onload=()=>{E(t);const f=S.current;if(f){const r=f.clientWidth-32,m=Math.min(r/t.width,450/t.height,1);I(m)}c(r=>({...r,regionX:Math.floor(t.width/4),regionY:Math.floor(t.height/4),regionWidth:Math.floor(t.width/2),regionHeight:Math.floor(t.height/2)}))},t.src=URL.createObjectURL(n)},y=(e=!0)=>{if(!d.current||!i)return;const n=d.current,t=n.getContext("2d");if(!t)return;n.width=i.width,n.height=i.height,t.drawImage(i,0,0);const f=(r,g,m,u)=>{const{pixelSize:h}=a;for(let p=g;p<g+u;p+=h)for(let x=r;x<r+m;x+=h){const U=Math.min(x+Math.floor(h/2),r+m-1),$=Math.min(p+Math.floor(h/2),g+u-1),N=t.getImageData(U,$,1,1).data;t.fillStyle=`rgb(${N[0]}, ${N[1]}, ${N[2]})`;const j=Math.min(h,r+m-x),O=Math.min(h,g+u-p);t.fillRect(x,p,j,O)}};if(a.mosaicType==="full")f(0,0,i.width,i.height);else{const{regionX:r,regionY:g,regionWidth:m,regionHeight:u}=a;f(r,g,m,u),e&&(t.strokeStyle="#3b82f6",t.lineWidth=2,t.setLineDash([5,5]),t.strokeRect(r,g,m,u),t.setLineDash([]))}};P(()=>{i&&y()},[i,a]);const R=e=>{const n=d.current;if(!n)return{x:0,y:0};const t=n.getBoundingClientRect();return{x:Math.round((e.clientX-t.left)/v),y:Math.round((e.clientY-t.top)/v)}},X=e=>{if(a.mosaicType!=="region")return;const n=R(e);C(!0),W(n)},Y=e=>{if(!L||a.mosaicType!=="region")return;const n=R(e);c(t=>({...t,regionX:Math.min(M.x,n.x),regionY:Math.min(M.y,n.y),regionWidth:Math.abs(n.x-M.x),regionHeight:Math.abs(n.y-M.y)}))},k=()=>{C(!1)},z=()=>{if(!d.current||!i)return;y(!1);const e=document.createElement("a");e.href=d.current.toDataURL("image/png"),e.download=`mosaic-${Date.now()}.png`,e.click(),y(!0)},B=()=>{i&&c(e=>({...e,regionX:Math.floor(i.width/4),regionY:Math.floor(i.height/4),regionWidth:Math.floor(i.width/2),regionHeight:Math.floor(i.height/2)}))};return s("div",{className:"flex flex-col gap-4",children:[s("div",{className:"flex gap-2 flex-wrap items-center",children:[o(T,{onClick:()=>H.current?.click(),children:l(i?"tools.imageMosaic.changeImage":"tools.imageMosaic.selectImage")}),o("input",{ref:H,type:"file",accept:"image/*",onChange:D,className:"hidden"}),o(T,{variant:"secondary",onClick:z,disabled:!i,children:l("common.download")}),a.mosaicType==="region"&&o(T,{variant:"secondary",onClick:B,disabled:!i,children:l("tools.imageMosaic.resetRegion")})]}),s("div",{className:"flex gap-4",children:[s("div",{className:"flex-1 flex flex-col gap-4",ref:S,children:[o("div",{className:"flex justify-center p-4 bg-slate-100 rounded-lg min-h-[400px] overflow-auto",children:i?o("canvas",{ref:d,onMouseDown:X,onMouseMove:Y,onMouseUp:k,onMouseLeave:k,className:`shadow-lg ${a.mosaicType==="region"?"cursor-crosshair":"cursor-default"}`,style:{width:i.width*v,height:i.height*v}}):o("div",{className:"flex items-center justify-center text-slate-400 h-full",children:l("tools.imageMosaic.placeholder")})}),a.mosaicType==="region"&&i&&o("div",{className:"p-3 bg-blue-50 rounded-lg border border-blue-200 text-sm text-blue-600",children:l("tools.imageMosaic.regionHint")})]}),s("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4",children:[o("h3",{className:"font-semibold text-slate-700",children:l("tools.imageMosaic.settings")}),s("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:l("tools.imageMosaic.mosaicType")}),s("select",{value:a.mosaicType,onChange:e=>c({...a,mosaicType:e.target.value}),className:"w-full p-2 border border-slate-200 rounded text-sm",children:[o("option",{value:"full",children:l("tools.imageMosaic.fullImage")}),o("option",{value:"region",children:l("tools.imageMosaic.regionOnly")})]})]}),s("div",{children:[s("label",{className:"block text-xs text-slate-500 mb-1",children:[l("tools.imageMosaic.pixelSize"),": ",a.pixelSize,"px"]}),o("input",{type:"range",min:"5",max:"50",value:a.pixelSize,onChange:e=>c({...a,pixelSize:Number(e.target.value)}),className:"w-full"}),s("div",{className:"flex justify-between text-xs text-slate-400 mt-1",children:[o("span",{children:l("tools.imageMosaic.fine")}),o("span",{children:l("tools.imageMosaic.coarse")})]})]}),a.mosaicType==="region"&&s("div",{className:"space-y-3 p-3 bg-slate-50 rounded-lg",children:[o("h4",{className:"text-xs font-medium text-slate-500",children:l("tools.imageMosaic.regionSettings")}),s("div",{className:"grid grid-cols-2 gap-2",children:[s("div",{children:[o("label",{className:"block text-xs text-slate-400",children:"X"}),o("input",{type:"number",value:a.regionX,onChange:e=>c({...a,regionX:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]}),s("div",{children:[o("label",{className:"block text-xs text-slate-400",children:"Y"}),o("input",{type:"number",value:a.regionY,onChange:e=>c({...a,regionY:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]}),s("div",{children:[o("label",{className:"block text-xs text-slate-400",children:l("tools.imageMosaic.width")}),o("input",{type:"number",value:a.regionWidth,onChange:e=>c({...a,regionWidth:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]}),s("div",{children:[o("label",{className:"block text-xs text-slate-400",children:l("tools.imageMosaic.height")}),o("input",{type:"number",value:a.regionHeight,onChange:e=>c({...a,regionHeight:Number(e.target.value)}),className:"w-full p-1 border border-slate-200 rounded text-sm"})]})]})]}),s("div",{className:"pt-4 border-t border-slate-200",children:[o("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:l("tools.imageMosaic.tips")}),s("ul",{className:"text-xs text-slate-500 space-y-1",children:[s("li",{children:["\u2022 ",l("tools.imageMosaic.tip1")]}),s("li",{children:["\u2022 ",l("tools.imageMosaic.tip2")]}),s("li",{children:["\u2022 ",l("tools.imageMosaic.tip3")]})]})]})]})]})]})}export{q as default};
