import{jsx as n,jsxs as o}from"react/jsx-runtime";import{useState as f,useRef as F}from"react";import{useTranslation as H}from"react-i18next";import g from"../../components/ui/Button";const d=["#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899"];function E(){const{t:c}=H(),x=F(null),[l,m]=f([{id:"1",label:"Visitors",value:1e4,color:d[0]},{id:"2",label:"Leads",value:6e3,color:d[1]},{id:"3",label:"Prospects",value:3500,color:d[2]},{id:"4",label:"Opportunities",value:1800,color:d[3]},{id:"5",label:"Customers",value:800,color:d[4]}]),[r,p]=f(null),[w,I]=f(!0),[N,M]=f(!0),L=Math.max(...l.map(e=>e.value),1),V=500,h=400/l.length,C=80,B=()=>{const e=Date.now().toString(),a=l.length%d.length,t=l.length>0?l[l.length-1].value:1e3;m([...l,{id:e,label:`Stage ${l.length+1}`,value:Math.max(Math.floor(t*.6),100),color:d[a]}])},b=(e,a)=>{m(l.map(t=>t.id===e?{...t,...a}:t))},R=e=>{l.length<=2||(m(l.filter(a=>a.id!==e)),p(null))},S=(e,a)=>{const t=l.findIndex(s=>s.id===e);if(a==="up"&&t>0){const s=[...l];[s[t-1],s[t]]=[s[t],s[t-1]],m(s)}else if(a==="down"&&t<l.length-1){const s=[...l];[s[t],s[t+1]]=[s[t+1],s[t]],m(s)}},P=()=>{if(!x.current)return;const e=new XMLSerializer().serializeToString(x.current),a=document.createElement("canvas"),t=a.getContext("2d"),s=new Image;a.width=600,a.height=450,s.onload=()=>{if(t){t.fillStyle="white",t.fillRect(0,0,a.width,a.height),t.drawImage(s,0,0);const i=document.createElement("a");i.download="funnel-chart.png",i.href=a.toDataURL("image/png"),i.click()}},s.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},k=e=>C+(V-C)*(e/L),v=r?l.find(e=>e.id===r):null;return o("div",{className:"flex flex-col gap-4",children:[o("div",{className:"flex gap-2 flex-wrap items-center",children:[n(g,{variant:"secondary",onClick:B,children:c("tools.funnelChart.addStage")}),o("div",{className:"flex items-center gap-2 ml-4",children:[o("label",{className:"flex items-center gap-1 text-sm",children:[n("input",{type:"checkbox",checked:w,onChange:e=>I(e.target.checked),className:"rounded"}),c("tools.funnelChart.showValues")]}),o("label",{className:"flex items-center gap-1 text-sm",children:[n("input",{type:"checkbox",checked:N,onChange:e=>M(e.target.checked),className:"rounded"}),c("tools.funnelChart.showPercentages")]})]}),n("div",{className:"flex-1"}),n(g,{variant:"secondary",onClick:P,children:c("common.download")})]}),o("div",{className:"flex gap-4",children:[n("div",{className:"flex-1 border border-slate-200 rounded-lg bg-white overflow-hidden shadow-inner p-4",onClick:()=>p(null),children:o("svg",{ref:x,viewBox:"0 0 600 450",className:"w-full select-none",children:[n("rect",{width:"600",height:"450",fill:"white"}),l.map((e,a)=>{const t=k(e.value),s=a<l.length-1?k(l[a+1].value):t*.7,i=30+a*h,u=300,y=r===e.id,W=a===0?100:Math.round(e.value/l[0].value*100),$=a>0?Math.round(e.value/l[a-1].value*100):null,z=`
                M ${u-t/2} ${i}
                L ${u+t/2} ${i}
                L ${u+s/2} ${i+h}
                L ${u-s/2} ${i+h}
                Z
              `;return o("g",{onClick:D=>{D.stopPropagation(),p(e.id)},className:"cursor-pointer",children:[n("path",{d:z,fill:e.color,stroke:y?"#1e293b":"white",strokeWidth:y?3:2,opacity:"0.9"}),n("text",{x:u,y:i+h/2-8,textAnchor:"middle",fontSize:"13",fontWeight:"600",fill:"white",children:e.label}),w&&o("text",{x:u,y:i+h/2+10,textAnchor:"middle",fontSize:"12",fill:"white",opacity:"0.9",children:[e.value.toLocaleString(),N&&` (${W}%)`]}),$!==null&&o("text",{x:u+t/2+15,y:i+15,fontSize:"10",fill:"#64748b",children:["\u2193 ",$,"%"]})]},e.id)})]})}),o("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4 max-h-[500px] overflow-auto",children:[n("h3",{className:"font-semibold text-slate-700",children:c("tools.funnelChart.properties")}),v?o("div",{className:"space-y-4",children:[o("div",{children:[n("label",{className:"block text-xs text-slate-500 mb-1",children:c("tools.funnelChart.label")}),n("input",{type:"text",value:v.label,onChange:e=>b(r,{label:e.target.value}),className:"input w-full"})]}),o("div",{children:[n("label",{className:"block text-xs text-slate-500 mb-1",children:c("tools.funnelChart.value")}),n("input",{type:"number",min:"1",value:v.value,onChange:e=>b(r,{value:Math.max(1,parseInt(e.target.value)||1)}),className:"input w-full"})]}),o("div",{children:[n("label",{className:"block text-xs text-slate-500 mb-1",children:c("tools.funnelChart.color")}),n("div",{className:"flex gap-1 flex-wrap",children:d.map(e=>n("button",{className:`w-6 h-6 rounded ${v.color===e?"ring-2 ring-offset-1 ring-slate-400":""}`,style:{backgroundColor:e},onClick:()=>b(r,{color:e})},e))})]}),o("div",{className:"flex gap-2",children:[o(g,{variant:"secondary",className:"flex-1 text-xs",onClick:()=>S(r,"up"),children:["\u2191 ",c("tools.funnelChart.moveUp")]}),o(g,{variant:"secondary",className:"flex-1 text-xs",onClick:()=>S(r,"down"),children:["\u2193 ",c("tools.funnelChart.moveDown")]})]}),l.length>2&&n(g,{variant:"secondary",className:"w-full text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>R(r),children:c("tools.funnelChart.delete")})]}):n("div",{className:"text-sm text-slate-400",children:c("tools.funnelChart.selectHint")}),o("div",{className:"mt-auto pt-4 border-t border-slate-200",children:[n("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:c("tools.funnelChart.summary")}),n("div",{className:"space-y-1 text-xs",children:l.map((e,a)=>o("div",{className:"flex items-center gap-2",children:[n("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:e.color}}),n("span",{className:"flex-1 truncate",children:e.label}),o("span",{className:"text-slate-500",children:[Math.round(e.value/l[0].value*100),"%"]})]},e.id))})]})]})]})]})}export{E as default};
