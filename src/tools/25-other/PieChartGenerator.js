import{jsx as t,jsxs as a}from"react/jsx-runtime";import{useState as g,useRef as K}from"react";import{useTranslation as Q}from"react-i18next";import k from"../../components/ui/Button";const i=["#3b82f6","#ef4444","#22c55e","#f59e0b","#8b5cf6","#ec4899","#06b6d4","#84cc16","#f97316","#6366f1"];function _(){const{t:n}=Q(),p=K(null),[s,b]=g([{id:"1",label:"Category A",value:30,color:i[0]},{id:"2",label:"Category B",value:25,color:i[1]},{id:"3",label:"Category C",value:20,color:i[2]},{id:"4",label:"Category D",value:15,color:i[3]},{id:"5",label:"Category E",value:10,color:i[4]}]),[d,v]=g(null),[S,z]=g(!0),[$,B]=g(!0),[x,E]=g(!1),h=s.reduce((e,l)=>e+l.value,0),D=()=>{const e=Date.now().toString(),l=s.length%i.length;b([...s,{id:e,label:`Category ${String.fromCharCode(65+s.length)}`,value:10,color:i[l]}])},C=(e,l)=>{b(s.map(o=>o.id===e?{...o,...l}:o))},G=e=>{s.length<=1||(b(s.filter(l=>l.id!==e)),v(null))},O=()=>{if(!p.current)return;const e=new XMLSerializer().serializeToString(p.current),l=document.createElement("canvas"),o=l.getContext("2d"),c=new Image;l.width=600,l.height=500,c.onload=()=>{if(o){o.fillStyle="white",o.fillRect(0,0,l.width,l.height),o.drawImage(c,0,0);const r=document.createElement("a");r.download="pie-chart.png",r.href=l.toDataURL("image/png"),r.click()}},c.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},W=()=>{const c=x?80:0;let r=-Math.PI/2;const M=[];return s.forEach(m=>{const w=h>0?m.value/h:0,y=w*Math.PI*2,u=r+y,I=200+Math.cos(r)*150,A=200+Math.sin(r)*150,X=200+Math.cos(u)*150,P=200+Math.sin(u)*150,T=200+Math.cos(r)*c,U=200+Math.sin(r)*c,V=200+Math.cos(u)*c,Z=200+Math.sin(u)*c,N=y>Math.PI?1:0,F=x?`M ${I} ${A} A 150 150 0 ${N} 1 ${X} ${P} L ${V} ${Z} A ${c} ${c} 0 ${N} 0 ${T} ${U} Z`:`M 200 200 L ${I} ${A} A 150 150 0 ${N} 1 ${X} ${P} Z`,Y=d===m.id,L=r+y/2,R=150*.7,H=200+Math.cos(L)*R,J=200+Math.sin(L)*R;M.push(a("g",{children:[t("path",{d:F,fill:m.color,stroke:Y?"#1e293b":"white",strokeWidth:Y?3:2,onClick:q=>{q.stopPropagation(),v(m.id)},className:"cursor-pointer transition-transform hover:scale-105",style:{transformOrigin:"200px 200px"}}),$&&w>.05&&a("text",{x:H,y:J,textAnchor:"middle",dy:"4",fontSize:"12",fontWeight:"600",fill:"white",className:"select-none pointer-events-none",children:[Math.round(w*100),"%"]})]},m.id)),r=u}),M},f=d?s.find(e=>e.id===d):null;return a("div",{className:"flex flex-col gap-4",children:[a("div",{className:"flex gap-2 flex-wrap items-center",children:[t(k,{variant:"secondary",onClick:D,children:n("tools.pieChart.addSlice")}),a("div",{className:"flex items-center gap-2 ml-4",children:[a("label",{className:"flex items-center gap-1 text-sm",children:[t("input",{type:"checkbox",checked:S,onChange:e=>z(e.target.checked),className:"rounded"}),n("tools.pieChart.showLabels")]}),a("label",{className:"flex items-center gap-1 text-sm",children:[t("input",{type:"checkbox",checked:$,onChange:e=>B(e.target.checked),className:"rounded"}),n("tools.pieChart.showPercentages")]}),a("label",{className:"flex items-center gap-1 text-sm",children:[t("input",{type:"checkbox",checked:x,onChange:e=>E(e.target.checked),className:"rounded"}),n("tools.pieChart.donut")]})]}),t("div",{className:"flex-1"}),t(k,{variant:"secondary",onClick:O,children:n("common.download")})]}),a("div",{className:"flex gap-4",children:[t("div",{className:"flex-1 border border-slate-200 rounded-lg bg-white overflow-hidden shadow-inner",onClick:()=>v(null),children:a("svg",{ref:p,viewBox:"0 0 600 500",className:"w-full select-none",children:[t("rect",{width:"600",height:"500",fill:"white"}),W(),S&&t("g",{transform:"translate(420, 100)",children:s.map((e,l)=>{const o=h>0?Math.round(e.value/h*100):0;return a("g",{transform:`translate(0, ${l*28})`,children:[t("rect",{width:"16",height:"16",rx:"2",fill:e.color}),t("text",{x:"24",y:"12",fontSize:"12",fill:"#1e293b",children:e.label.length>12?e.label.slice(0,12)+"...":e.label}),a("text",{x:"140",y:"12",fontSize:"11",fill:"#64748b",textAnchor:"end",children:[e.value," (",o,"%)"]})]},e.id)})}),x&&a("g",{transform:"translate(200, 200)",children:[t("text",{textAnchor:"middle",dy:"-5",fontSize:"14",fill:"#64748b",children:n("tools.pieChart.total")}),t("text",{textAnchor:"middle",dy:"18",fontSize:"24",fontWeight:"bold",fill:"#1e293b",children:h})]})]})}),a("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4",children:[t("h3",{className:"font-semibold text-slate-700",children:n("tools.pieChart.properties")}),f?a("div",{className:"space-y-4",children:[a("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:n("tools.pieChart.label")}),t("input",{type:"text",value:f.label,onChange:e=>C(d,{label:e.target.value}),className:"input w-full"})]}),a("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:n("tools.pieChart.value")}),t("input",{type:"number",min:"0",value:f.value,onChange:e=>C(d,{value:Math.max(0,parseFloat(e.target.value)||0)}),className:"input w-full"})]}),a("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:n("tools.pieChart.color")}),t("div",{className:"flex gap-1 flex-wrap",children:i.map(e=>t("button",{className:`w-6 h-6 rounded ${f.color===e?"ring-2 ring-offset-1 ring-slate-400":""}`,style:{backgroundColor:e},onClick:()=>C(d,{color:e})},e))})]}),s.length>1&&t(k,{variant:"secondary",className:"w-full text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>G(d),children:n("tools.pieChart.delete")})]}):t("div",{className:"text-sm text-slate-400",children:n("tools.pieChart.selectHint")}),a("div",{className:"mt-auto pt-4 border-t border-slate-200",children:[t("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:n("tools.pieChart.data")}),t("div",{className:"space-y-1 text-xs max-h-40 overflow-auto",children:s.map(e=>a("div",{className:"flex items-center gap-2 py-1",children:[t("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:e.color}}),t("span",{className:"flex-1 truncate text-slate-600",children:e.label}),t("span",{className:"text-slate-500",children:e.value})]},e.id))})]})]})]})]})}export{_ as default};
