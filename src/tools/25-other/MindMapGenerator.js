import{jsx as o,jsxs as a}from"react/jsx-runtime";import{useState as k,useRef as V,useEffect as A}from"react";import{useTranslation as H}from"react-i18next";import C from"../../components/ui/Button";const N=["#3b82f6","#ef4444","#22c55e","#f59e0b","#8b5cf6","#ec4899","#06b6d4","#84cc16"];function Q(){const{t:m}=H(),M=V(null),[u,g]=k(null),[c,w]=k({id:"root",text:"Main Topic",children:[{id:"1",text:"Branch 1",children:[{id:"1-1",text:"Sub-item 1.1",children:[]},{id:"1-2",text:"Sub-item 1.2",children:[]}]},{id:"2",text:"Branch 2",children:[{id:"2-1",text:"Sub-item 2.1",children:[]}]},{id:"3",text:"Branch 3",children:[]}]}),[R,z]=k(new Map);A(()=>{const e=new Map,t=400,i=300;e.set("root",{x:t,y:i});const n=(l,s,h,f,r,d,x)=>{if(l.length===0)return;const v=(r-f)/l.length;l.forEach((p,O)=>{const b=f+v*(O+.5),B=s+Math.cos(b)*d,$=h+Math.sin(b)*d;if(e.set(p.id,{x:B,y:$}),p.children.length>0&&!p.collapsed){const U=Math.max(60,d*.7),X=Math.min(Math.PI/2,v*.8);n(p.children,B,$,b-X/2,b+X/2,U,x+1)}})};n(c.children,t,i,-Math.PI,Math.PI,150,0),z(e)},[c]);const y=(e,t)=>{if(e.id===t)return e;for(const i of e.children){const n=y(i,t);if(n)return n}return null},D=(e,t)=>{for(const i of e.children){if(i.id===t)return e;const n=D(i,t);if(n)return n}return null},E=(e,t)=>{const i=n=>n.id===e?{...n,...t}:{...n,children:n.children.map(i)};w(i(c))},W=e=>{const t=Date.now().toString(),i=n=>n.id===e?{...n,collapsed:!1,children:[...n.children,{id:t,text:"New Item",children:[]}]}:{...n,children:n.children.map(i)};w(i(c)),g(t)},G=e=>{if(e==="root")return;const t=i=>({...i,children:i.children.filter(n=>n.id!==e).map(t)});w(t(c)),g(null)},J=e=>{const t=y(c,e);t&&t.children.length>0&&E(e,{collapsed:!t.collapsed})},L=e=>{const t=(i,n)=>{if(i.id===e)return n;for(const l of i.children){const s=t(l,n+1);if(s>=0)return s}return-1};return t(c,0)},I=(e,t,i=0)=>{const n=R.get(e.id);if(!n)return null;const l=[];if(t){const s=(t.x+n.x)/2;l.push(o("path",{d:`M ${t.x} ${t.y} Q ${s} ${t.y} ${n.x} ${n.y}`,stroke:N[i%N.length],strokeWidth:"2",fill:"none",opacity:"0.6"},`conn-${e.id}`))}return e.collapsed||e.children.forEach((s,h)=>{const f=e.id==="root"?h:i,r=I(s,n,f);r&&l.push(...r)}),l},P=(e,t=0)=>{const i=R.get(e.id);if(!i)return[];const n=[],l=u===e.id,s=e.id==="root",h=s?"#1e293b":N[t%N.length],f=L(e.id),r=Math.max(10,14-f*2),d=Math.max(6,12-f*2);return n.push(a("g",{transform:`translate(${i.x}, ${i.y})`,onClick:x=>{x.stopPropagation(),g(e.id)},onDoubleClick:x=>{x.stopPropagation(),J(e.id)},className:"cursor-pointer",children:[o("rect",{x:-e.text.length*r*.3-d,y:-r-d/2,width:e.text.length*r*.6+d*2,height:r*2+d,rx:"4",fill:s?h:"white",stroke:l?"#3b82f6":h,strokeWidth:l?3:2}),o("text",{textAnchor:"middle",dy:"4",fill:s?"white":"#1e293b",fontSize:r,fontWeight:s?"600":"500",className:"select-none pointer-events-none",children:e.text}),e.children.length>0&&o("circle",{cx:e.text.length*r*.3+d+8,cy:"0",r:"8",fill:e.collapsed?h:"white",stroke:h,strokeWidth:"2"}),e.children.length>0&&o("text",{x:e.text.length*r*.3+d+8,y:"4",textAnchor:"middle",fontSize:"10",fill:e.collapsed?"white":h,fontWeight:"bold",className:"select-none pointer-events-none",children:e.collapsed?"+":"-"})]},e.id)),e.collapsed||e.children.forEach((x,v)=>{const p=e.id==="root"?v:t;n.push(...P(x,p))}),n},T=()=>{if(!M.current)return;const e=new XMLSerializer().serializeToString(M.current),t=document.createElement("canvas"),i=t.getContext("2d"),n=new Image;t.width=800,t.height=600,n.onload=()=>{if(i){i.fillStyle="white",i.fillRect(0,0,t.width,t.height),i.drawImage(n,0,0);const l=document.createElement("a");l.download="mindmap.png",l.href=t.toDataURL("image/png"),l.click()}},n.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},S=u?y(c,u):null;return a("div",{className:"flex flex-col gap-4 h-[600px]",children:[a("div",{className:"flex gap-2 items-center",children:[o(C,{variant:"secondary",onClick:()=>W(u||"root"),children:m("tools.mindMap.addChild")}),u&&u!=="root"&&o(C,{variant:"secondary",className:"text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>G(u),children:m("tools.mindMap.delete")}),o("div",{className:"flex-1"}),o(C,{variant:"secondary",onClick:T,children:m("common.download")})]}),a("div",{className:"flex gap-4 flex-1 min-h-0",children:[a("div",{className:"flex-1 border border-slate-200 rounded-lg bg-white overflow-hidden shadow-inner relative",onClick:()=>g(null),children:[a("svg",{ref:M,viewBox:"0 0 800 600",className:"w-full h-full select-none",children:[I(c),P(c)]}),o("div",{className:"absolute bottom-2 left-2 text-xs text-slate-400 pointer-events-none",children:m("tools.mindMap.hint")}),o("div",{className:"absolute bottom-2 right-2 text-xs text-slate-400 pointer-events-none",children:"800 x 600"})]}),a("div",{className:"w-64 border-l border-slate-200 pl-4 flex flex-col gap-4",children:[o("h3",{className:"font-semibold text-slate-700",children:m("tools.mindMap.properties")}),S?a("div",{className:"space-y-4",children:[a("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:m("tools.mindMap.text")}),o("input",{type:"text",value:S.text,onChange:e=>E(u,{text:e.target.value}),className:"input w-full"})]}),a("div",{className:"text-xs text-slate-500",children:[m("tools.mindMap.children"),": ",S.children.length]})]}):o("div",{className:"text-sm text-slate-400",children:m("tools.mindMap.selectHint")})]})]})]})}export{Q as default};
