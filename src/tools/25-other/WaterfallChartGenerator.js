import{jsx as t,jsxs as s}from"react/jsx-runtime";import{useState as w,useRef as H}from"react";import{useTranslation as L}from"react-i18next";import C from"../../components/ui/Button";function U(){const{t:r}=L(),k=H(null),[c,N]=w([{id:"1",label:"Start",value:100,type:"total"},{id:"2",label:"Revenue",value:50,type:"increase"},{id:"3",label:"Costs",value:-30,type:"decrease"},{id:"4",label:"Marketing",value:-15,type:"decrease"},{id:"5",label:"Other Income",value:20,type:"increase"},{id:"6",label:"End",value:125,type:"total"}]),[u,I]=w(null),[S,D]=w(!0),[W,P]=w(!0),n={top:40,right:40,bottom:80,left:60},x=600-n.left-n.right,m=350-n.top-n.bottom,v=(()=>{let e=0;return c.map((a,l)=>{let o,i;return a.type==="total"?(o=0,i=a.value,e=a.value):(o=e,i=e+a.value,e=i),{...a,start:o,end:i,index:l}})})(),M=v.flatMap(e=>[e.start,e.end]),g=Math.min(...M,0),V=Math.max(...M)-g||1,d=Math.min(60,x/c.length*.7),h=(x-d*c.length)/(c.length+1),f=e=>n.top+m-(e-g)/V*m,E=()=>{const e=Date.now().toString(),a=c.length-1,l=[...c];l.splice(a,0,{id:e,label:`Item ${c.length}`,value:10,type:"increase"}),N(l)},p=(e,a)=>{N(c.map(l=>l.id===e?{...l,...a}:l))},T=e=>{c.length<=2||(N(c.filter(a=>a.id!==e)),I(null))},$=()=>{const e=c.slice(0,-1).reduce((l,o)=>o.type==="total"?o.value:l+o.value,0),a=c[c.length-1];a.type==="total"&&p(a.id,{value:e})},A=()=>{if(!k.current)return;const e=new XMLSerializer().serializeToString(k.current),a=document.createElement("canvas"),l=a.getContext("2d"),o=new Image;a.width=600,a.height=400,o.onload=()=>{if(l){l.fillStyle="white",l.fillRect(0,0,a.width,a.height),l.drawImage(o,0,0);const i=document.createElement("a");i.download="waterfall-chart.png",i.href=a.toDataURL("image/png"),i.click()}},o.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},z=(e,a)=>e==="total"?"#64748b":a>=0?"#22c55e":"#ef4444",b=u?c.find(e=>e.id===u):null;return s("div",{className:"flex flex-col gap-4",children:[s("div",{className:"flex gap-2 flex-wrap items-center",children:[t(C,{variant:"secondary",onClick:E,children:r("tools.waterfallChart.addItem")}),t(C,{variant:"secondary",onClick:$,children:r("tools.waterfallChart.recalculate")}),s("div",{className:"flex items-center gap-2 ml-4",children:[s("label",{className:"flex items-center gap-1 text-sm",children:[t("input",{type:"checkbox",checked:S,onChange:e=>D(e.target.checked),className:"rounded"}),r("tools.waterfallChart.showValues")]}),s("label",{className:"flex items-center gap-1 text-sm",children:[t("input",{type:"checkbox",checked:W,onChange:e=>P(e.target.checked),className:"rounded"}),r("tools.waterfallChart.showConnectors")]})]}),t("div",{className:"flex-1"}),t(C,{variant:"secondary",onClick:A,children:r("common.download")})]}),s("div",{className:"flex gap-4",children:[t("div",{className:"flex-1 border border-slate-200 rounded-lg bg-white overflow-hidden shadow-inner",onClick:()=>I(null),children:s("svg",{ref:k,viewBox:"0 0 600 400",className:"w-full select-none",children:[t("rect",{width:"600",height:"400",fill:"white"}),t("line",{x1:n.left,y1:n.top,x2:n.left,y2:n.top+m,stroke:"#cbd5e1",strokeWidth:"2"}),g<0&&t("line",{x1:n.left,y1:f(0),x2:n.left+x,y2:f(0),stroke:"#94a3b8",strokeWidth:"1",strokeDasharray:"4,4"}),[0,.25,.5,.75,1].map((e,a)=>{const l=g+e*V,o=f(l);return s("g",{children:[t("line",{x1:n.left,y1:o,x2:n.left+x,y2:o,stroke:"#e2e8f0",strokeDasharray:"4,4"}),t("text",{x:n.left-8,y:o+4,textAnchor:"end",fontSize:"10",fill:"#94a3b8",children:Math.round(l)})]},a)}),W&&v.slice(0,-1).map((e,a)=>{const l=v[a+1],o=n.left+h+a*(d+h)+d,i=n.left+h+(a+1)*(d+h),y=f(e.end);return t("line",{x1:o,y1:y,x2:i,y2:y,stroke:"#94a3b8",strokeWidth:"1",strokeDasharray:"2,2"},`conn-${a}`)}),v.map(e=>{const a=n.left+h+e.index*(d+h),l=f(e.start),o=f(e.end),i=Math.min(l,o),y=Math.abs(o-l),R=u===e.id,B=z(e.type,e.value);return s("g",{onClick:G=>{G.stopPropagation(),I(e.id)},className:"cursor-pointer",children:[t("rect",{x:a,y:i,width:d,height:Math.max(y,2),fill:B,stroke:R?"#1e293b":"none",strokeWidth:R?2:0,rx:"2"}),S&&t("text",{x:a+d/2,y:i-8,textAnchor:"middle",fontSize:"10",fontWeight:"600",fill:B,children:e.type==="total"?e.value:(e.value>=0?"+":"")+e.value}),t("text",{x:a+d/2,y:n.top+m+20,textAnchor:"middle",fontSize:"10",fill:"#64748b",transform:`rotate(-30, ${a+d/2}, ${n.top+m+20})`,children:e.label.length>10?e.label.slice(0,10)+"..":e.label})]},e.id)}),s("g",{transform:"translate(480, 20)",children:[t("rect",{x:"0",y:"0",width:"12",height:"12",fill:"#22c55e",rx:"2"}),t("text",{x:"18",y:"10",fontSize:"10",fill:"#64748b",children:r("tools.waterfallChart.increase")}),t("rect",{x:"0",y:"18",width:"12",height:"12",fill:"#ef4444",rx:"2"}),t("text",{x:"18",y:"28",fontSize:"10",fill:"#64748b",children:r("tools.waterfallChart.decrease")}),t("rect",{x:"0",y:"36",width:"12",height:"12",fill:"#64748b",rx:"2"}),t("text",{x:"18",y:"46",fontSize:"10",fill:"#64748b",children:r("tools.waterfallChart.total")})]})]})}),s("div",{className:"w-64 border border-slate-200 rounded-lg bg-white p-4 flex flex-col gap-4 max-h-[500px] overflow-auto",children:[t("h3",{className:"font-semibold text-slate-700",children:r("tools.waterfallChart.properties")}),b?s("div",{className:"space-y-4",children:[s("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:r("tools.waterfallChart.label")}),t("input",{type:"text",value:b.label,onChange:e=>p(u,{label:e.target.value}),className:"input w-full"})]}),s("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:r("tools.waterfallChart.value")}),t("input",{type:"number",value:b.value,onChange:e=>p(u,{value:parseInt(e.target.value)||0}),className:"input w-full"})]}),s("div",{children:[t("label",{className:"block text-xs text-slate-500 mb-1",children:r("tools.waterfallChart.type")}),s("select",{value:b.type,onChange:e=>p(u,{type:e.target.value}),className:"input w-full",children:[t("option",{value:"increase",children:r("tools.waterfallChart.increase")}),t("option",{value:"decrease",children:r("tools.waterfallChart.decrease")}),t("option",{value:"total",children:r("tools.waterfallChart.total")})]})]}),c.length>2&&t(C,{variant:"secondary",className:"w-full text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>T(u),children:r("tools.waterfallChart.delete")})]}):t("div",{className:"text-sm text-slate-400",children:r("tools.waterfallChart.selectHint")}),s("div",{className:"mt-auto pt-4 border-t border-slate-200",children:[t("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:r("tools.waterfallChart.data")}),t("div",{className:"space-y-1 text-xs max-h-32 overflow-auto",children:c.map(e=>s("div",{className:"flex items-center gap-2 py-1",children:[t("div",{className:"w-3 h-3 rounded-sm flex-shrink-0",style:{backgroundColor:z(e.type,e.value)}}),t("span",{className:"flex-1 truncate",children:e.label}),s("span",{className:e.value>=0?"text-green-600":"text-red-600",children:[e.value>=0?"+":"",e.value]})]},e.id))})]})]})]})]})}export{U as default};
