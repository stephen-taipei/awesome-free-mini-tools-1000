import{jsx as o,jsxs as n}from"react/jsx-runtime";import{useState as f,useRef as Y}from"react";import{useTranslation as X}from"react-i18next";import L from"../../components/ui/Button";const D={start:"#22c55e",end:"#ef4444",process:"#3b82f6",decision:"#f59e0b",io:"#8b5cf6"};function T(){const{t:a}=X(),p=Y(null),[c,g]=f([{id:"1",x:400,y:50,label:"Start",type:"start"},{id:"2",x:400,y:150,label:"Process",type:"process"},{id:"3",x:400,y:250,label:"Decision?",type:"decision"},{id:"4",x:250,y:350,label:"Yes Action",type:"process"},{id:"5",x:550,y:350,label:"No Action",type:"process"},{id:"6",x:400,y:450,label:"End",type:"end"}]),[y,k]=f([{id:"l1",sourceId:"1",targetId:"2",label:""},{id:"l2",sourceId:"2",targetId:"3",label:""},{id:"l3",sourceId:"3",targetId:"4",label:"Yes"},{id:"l4",sourceId:"3",targetId:"5",label:"No"},{id:"l5",sourceId:"4",targetId:"6",label:""},{id:"l6",sourceId:"5",targetId:"6",label:""}]),[r,w]=f(null),[d,u]=f("select"),[m,F]=f("process"),[x,v]=f(null),[R,I]=f(!1),[S,$]=f({x:0,y:0}),W=e=>{if(d==="addNode"){const t=p.current?.getBoundingClientRect();if(!t)return;const l=e.clientX-t.left,s=e.clientY-t.top,i={id:Date.now().toString(),x:l,y:s,label:m==="decision"?"Condition?":m.charAt(0).toUpperCase()+m.slice(1),type:m};g([...c,i]),u("select")}else w(null),v(null)},h=(e,t)=>{if(e.stopPropagation(),d==="addLink"){if(x===null)v(t);else if(x!==t){const s={id:Date.now().toString(),sourceId:x,targetId:t,label:""};k([...y,s]),v(null),u("select")}return}w(t),I(!0);const l=c.find(s=>s.id===t);if(l){const s=p.current?.getBoundingClientRect();s&&$({x:e.clientX-s.left-l.x,y:e.clientY-s.top-l.y})}},A=e=>{if(R&&r&&d==="select"){const t=p.current?.getBoundingClientRect();if(!t)return;const l=e.clientX-t.left-S.x,s=e.clientY-t.top-S.y;g(c.map(i=>i.id===r?{...i,x:l,y:s}:i))}},C=()=>{I(!1)},M=e=>{r&&g(c.map(t=>t.id===r?{...t,...e}:t))},z=()=>{r&&(g(c.filter(e=>e.id!==r)),k(y.filter(e=>e.sourceId!==r&&e.targetId!==r)),w(null))},E=()=>{if(!p.current)return;const e=new XMLSerializer().serializeToString(p.current),t=document.createElement("canvas"),l=t.getContext("2d"),s=new Image;t.width=800,t.height=600,s.onload=()=>{if(l){l.fillStyle="white",l.fillRect(0,0,t.width,t.height),l.drawImage(s,0,0);const i=document.createElement("a");i.download="flowchart.png",i.href=t.toDataURL("image/png"),i.click()}},s.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},B=e=>{const t=r===e.id,l=D[e.type];switch(e.type){case"start":case"end":return n("g",{transform:`translate(${e.x}, ${e.y})`,onMouseDown:s=>h(s,e.id),className:"cursor-move",children:[o("ellipse",{rx:"40",ry:"25",fill:l,stroke:t?"#1e40af":"#fff",strokeWidth:t?3:2}),o("text",{textAnchor:"middle",dy:"5",fill:"white",fontSize:"12",fontWeight:"500",className:"select-none pointer-events-none",children:e.label})]},e.id);case"process":return n("g",{transform:`translate(${e.x}, ${e.y})`,onMouseDown:s=>h(s,e.id),className:"cursor-move",children:[o("rect",{x:"-50",y:"-25",width:"100",height:"50",rx:"4",fill:l,stroke:t?"#1e40af":"#fff",strokeWidth:t?3:2}),o("text",{textAnchor:"middle",dy:"5",fill:"white",fontSize:"12",fontWeight:"500",className:"select-none pointer-events-none",children:e.label})]},e.id);case"decision":return n("g",{transform:`translate(${e.x}, ${e.y})`,onMouseDown:s=>h(s,e.id),className:"cursor-move",children:[o("polygon",{points:"0,-35 50,0 0,35 -50,0",fill:l,stroke:t?"#1e40af":"#fff",strokeWidth:t?3:2}),o("text",{textAnchor:"middle",dy:"5",fill:"white",fontSize:"11",fontWeight:"500",className:"select-none pointer-events-none",children:e.label})]},e.id);case"io":return n("g",{transform:`translate(${e.x}, ${e.y})`,onMouseDown:s=>h(s,e.id),className:"cursor-move",children:[o("polygon",{points:"-40,-25 50,-25 40,25 -50,25",fill:l,stroke:t?"#1e40af":"#fff",strokeWidth:t?3:2}),o("text",{textAnchor:"middle",dy:"5",fill:"white",fontSize:"12",fontWeight:"500",className:"select-none pointer-events-none",children:e.label})]},e.id)}},b=c.find(e=>e.id===r);return n("div",{className:"flex flex-col gap-4 h-[600px]",children:[n("div",{className:"flex gap-2 flex-wrap items-center",children:[n("div",{className:"flex rounded-lg bg-slate-100 p-1",children:[o("button",{className:`px-3 py-1 rounded text-sm font-medium transition-colors ${d==="select"?"bg-white text-primary-600 shadow-sm":"text-slate-600 hover:text-slate-900"}`,onClick:()=>u("select"),children:a("tools.flowchart.select")}),o("button",{className:`px-3 py-1 rounded text-sm font-medium transition-colors ${d==="addNode"?"bg-white text-primary-600 shadow-sm":"text-slate-600 hover:text-slate-900"}`,onClick:()=>u("addNode"),children:a("tools.flowchart.addNode")}),o("button",{className:`px-3 py-1 rounded text-sm font-medium transition-colors ${d==="addLink"?"bg-white text-primary-600 shadow-sm":"text-slate-600 hover:text-slate-900"}`,onClick:()=>u("addLink"),children:a("tools.flowchart.addLink")})]}),d==="addNode"&&n("select",{value:m,onChange:e=>F(e.target.value),className:"input py-1 text-sm",children:[o("option",{value:"start",children:a("tools.flowchart.types.start")}),o("option",{value:"end",children:a("tools.flowchart.types.end")}),o("option",{value:"process",children:a("tools.flowchart.types.process")}),o("option",{value:"decision",children:a("tools.flowchart.types.decision")}),o("option",{value:"io",children:a("tools.flowchart.types.io")})]}),d==="addLink"&&x&&o("span",{className:"text-sm text-primary-600 animate-pulse",children:a("tools.flowchart.selectTarget")}),o("div",{className:"flex-1"}),o(L,{variant:"secondary",onClick:E,children:a("common.download")})]}),n("div",{className:"flex gap-4 flex-1 min-h-0",children:[n("div",{className:"flex-1 border border-slate-200 rounded-lg bg-white overflow-hidden shadow-inner relative cursor-crosshair",onMouseMove:A,onMouseUp:C,onMouseLeave:C,onClick:W,children:[n("svg",{ref:p,viewBox:"0 0 800 600",className:"w-full h-full select-none",children:[o("defs",{children:o("marker",{id:"flowArrow",markerWidth:"10",markerHeight:"7",refX:"9",refY:"3.5",orient:"auto",children:o("polygon",{points:"0 0, 10 3.5, 0 7",fill:"#64748b"})})}),y.map(e=>{const t=c.find(N=>N.id===e.sourceId),l=c.find(N=>N.id===e.targetId);if(!t||!l)return null;const s=(t.x+l.x)/2,i=(t.y+l.y)/2;return n("g",{children:[o("line",{x1:t.x,y1:t.y,x2:l.x,y2:l.y,stroke:"#64748b",strokeWidth:"2",markerEnd:"url(#flowArrow)"}),e.label&&o("text",{x:s,y:i,dy:"-5",textAnchor:"middle",fill:"#475569",fontSize:"11",fontWeight:"500",children:e.label})]},e.id)}),c.map(B)]}),o("div",{className:"absolute bottom-2 right-2 text-xs text-slate-400 pointer-events-none",children:"800 x 600"})]}),n("div",{className:"w-64 border-l border-slate-200 pl-4 flex flex-col gap-4",children:[o("h3",{className:"font-semibold text-slate-700",children:a("tools.flowchart.properties")}),b?n("div",{className:"space-y-4",children:[n("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:a("tools.flowchart.label")}),o("input",{type:"text",value:b.label,onChange:e=>M({label:e.target.value}),className:"input w-full"})]}),n("div",{children:[o("label",{className:"block text-xs text-slate-500 mb-1",children:a("tools.flowchart.type")}),n("select",{value:b.type,onChange:e=>M({type:e.target.value}),className:"input w-full",children:[o("option",{value:"start",children:a("tools.flowchart.types.start")}),o("option",{value:"end",children:a("tools.flowchart.types.end")}),o("option",{value:"process",children:a("tools.flowchart.types.process")}),o("option",{value:"decision",children:a("tools.flowchart.types.decision")}),o("option",{value:"io",children:a("tools.flowchart.types.io")})]})]}),o(L,{variant:"secondary",className:"w-full text-red-500 hover:text-red-600 hover:bg-red-50",onClick:z,children:a("tools.flowchart.delete")})]}):o("div",{className:"text-sm text-slate-400",children:a("tools.flowchart.selectHint")}),n("div",{className:"mt-auto pt-4 border-t border-slate-200",children:[o("h4",{className:"text-xs font-medium text-slate-500 mb-2",children:a("tools.flowchart.legend")}),o("div",{className:"space-y-1 text-xs",children:Object.entries(D).map(([e,t])=>n("div",{className:"flex items-center gap-2",children:[o("div",{className:"w-3 h-3 rounded-sm",style:{backgroundColor:t}}),o("span",{className:"text-slate-600 capitalize",children:a(`tools.flowchart.types.${e}`)})]},e))})]})]})]})]})}export{T as default};
