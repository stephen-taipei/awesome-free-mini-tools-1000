import{jsx as i,jsxs as s}from"react/jsx-runtime";import{useState as y,useRef as G,useEffect as J}from"react";import{useTranslation as X}from"react-i18next";import S from"../../components/ui/Button";const R=["#3b82f6","#8b5cf6","#06b6d4","#22c55e","#f59e0b","#ef4444"];function z(){const{t:d}=X(),p=G(null),[h,f]=y(null),[a,v]=y({id:"root",name:"John Smith",title:"CEO",children:[{id:"1",name:"Alice Johnson",title:"CTO",children:[{id:"1-1",name:"Bob Wilson",title:"Dev Lead",children:[]},{id:"1-2",name:"Carol Davis",title:"QA Lead",children:[]}]},{id:"2",name:"David Brown",title:"CFO",children:[{id:"2-1",name:"Eve Taylor",title:"Accountant",children:[]}]},{id:"3",name:"Frank Miller",title:"COO",children:[]}]}),[x,W]=y(new Map),g=120,m=60,N=20,b=60;J(()=>{const e=new Map,t=r=>{if(r.children.length===0||r.collapsed)return g;const o=r.children.reduce((c,O)=>c+t(O)+N,-N);return Math.max(g,o)},l=(r,o,c,O)=>{const D=t(r);if(e.set(r.id,{x:o+D/2,y:c,width:D}),!r.collapsed&&r.children.length>0){let P=o;r.children.forEach($=>{const T=t($);l($,P,c+m+b,O+1),P+=T+N})}},n=t(a);l(a,400-n/2,30,0),W(e)},[a]);const w=(e,t)=>{if(e.id===t)return e;for(const l of e.children){const n=w(l,t);if(n)return n}return null},I=e=>{const t=(l,n)=>{if(l.id===e)return n;for(const r of l.children){const o=t(r,n+1);if(o>=0)return o}return-1};return t(a,0)},C=(e,t)=>{const l=n=>n.id===e?{...n,...t}:{...n,children:n.children.map(l)};v(l(a))},A=e=>{const t=Date.now().toString(),l=n=>n.id===e?{...n,collapsed:!1,children:[...n.children,{id:t,name:"New Person",title:"Title",children:[]}]}:{...n,children:n.children.map(l)};v(l(a)),f(t)},L=e=>{if(e==="root")return;const t=l=>({...l,children:l.children.filter(n=>n.id!==e).map(t)});v(t(a)),f(null)},M=e=>{const t=w(a,e);t&&t.children.length>0&&C(e,{collapsed:!t.collapsed})},k=e=>{const t=[],l=x.get(e.id);return!l||e.collapsed||e.children.forEach(n=>{const r=x.get(n.id);r&&(t.push(i("path",{d:`M ${l.x} ${l.y+m}
                L ${l.x} ${l.y+m+b/2}
                L ${r.x} ${l.y+m+b/2}
                L ${r.x} ${r.y}`,stroke:"#94a3b8",strokeWidth:"2",fill:"none"},`conn-${n.id}`)),t.push(...k(n)))}),t},E=e=>{const t=[],l=x.get(e.id);if(!l)return t;const n=h===e.id,r=I(e.id),o=R[r%R.length];return t.push(s("g",{transform:`translate(${l.x-g/2}, ${l.y})`,onClick:c=>{c.stopPropagation(),f(e.id)},onDoubleClick:c=>{c.stopPropagation(),M(e.id)},className:"cursor-pointer",children:[i("rect",{width:g,height:m,rx:"6",fill:"white",stroke:n?"#3b82f6":o,strokeWidth:n?3:2,filter:"url(#shadow)"}),i("rect",{width:g,height:"6",rx:"6",fill:o}),i("text",{x:g/2,y:"28",textAnchor:"middle",fontSize:"11",fontWeight:"600",fill:"#1e293b",className:"select-none pointer-events-none",children:e.name.length>14?e.name.slice(0,14)+"...":e.name}),i("text",{x:g/2,y:"44",textAnchor:"middle",fontSize:"10",fill:"#64748b",className:"select-none pointer-events-none",children:e.title.length>16?e.title.slice(0,16)+"...":e.title}),e.children.length>0&&s("g",{transform:`translate(${g/2}, ${m})`,children:[i("circle",{r:"10",fill:e.collapsed?o:"white",stroke:o,strokeWidth:"2"}),i("text",{textAnchor:"middle",dy:"4",fontSize:"12",fontWeight:"bold",fill:e.collapsed?"white":o,className:"select-none pointer-events-none",children:e.collapsed?"+":"-"})]})]},e.id)),e.collapsed||e.children.forEach(c=>{t.push(...E(c))}),t},B=()=>{if(!p.current)return;const e=new XMLSerializer().serializeToString(p.current),t=document.createElement("canvas"),l=t.getContext("2d"),n=new Image;t.width=800,t.height=600,n.onload=()=>{if(l){l.fillStyle="white",l.fillRect(0,0,t.width,t.height),l.drawImage(n,0,0);const r=document.createElement("a");r.download="org-chart.png",r.href=t.toDataURL("image/png"),r.click()}},n.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e)))},u=h?w(a,h):null;return s("div",{className:"flex flex-col gap-4 h-[600px]",children:[s("div",{className:"flex gap-2 items-center",children:[i(S,{variant:"secondary",onClick:()=>A(h||"root"),children:d("tools.orgChart.addMember")}),h&&h!=="root"&&i(S,{variant:"secondary",className:"text-red-500 hover:text-red-600 hover:bg-red-50",onClick:()=>L(h),children:d("tools.orgChart.delete")}),i("div",{className:"flex-1"}),i(S,{variant:"secondary",onClick:B,children:d("common.download")})]}),s("div",{className:"flex gap-4 flex-1 min-h-0",children:[s("div",{className:"flex-1 border border-slate-200 rounded-lg bg-slate-50 overflow-auto shadow-inner relative",onClick:()=>f(null),children:[s("svg",{ref:p,viewBox:"0 0 800 600",className:"w-full h-full select-none",children:[i("defs",{children:i("filter",{id:"shadow",x:"-20%",y:"-20%",width:"140%",height:"140%",children:i("feDropShadow",{dx:"0",dy:"2",stdDeviation:"3",floodOpacity:"0.1"})})}),i("rect",{width:"800",height:"600",fill:"#f8fafc"}),k(a),E(a)]}),i("div",{className:"absolute bottom-2 left-2 text-xs text-slate-400 pointer-events-none",children:d("tools.orgChart.hint")})]}),s("div",{className:"w-64 border-l border-slate-200 pl-4 flex flex-col gap-4",children:[i("h3",{className:"font-semibold text-slate-700",children:d("tools.orgChart.properties")}),u?s("div",{className:"space-y-4",children:[s("div",{children:[i("label",{className:"block text-xs text-slate-500 mb-1",children:d("tools.orgChart.name")}),i("input",{type:"text",value:u.name,onChange:e=>C(h,{name:e.target.value}),className:"input w-full"})]}),s("div",{children:[i("label",{className:"block text-xs text-slate-500 mb-1",children:d("tools.orgChart.title")}),i("input",{type:"text",value:u.title,onChange:e=>C(h,{title:e.target.value}),className:"input w-full"})]}),s("div",{className:"text-xs text-slate-500",children:[d("tools.orgChart.reports"),": ",u.children.length]})]}):i("div",{className:"text-sm text-slate-400",children:d("tools.orgChart.selectHint")})]})]})]})}export{z as default};
